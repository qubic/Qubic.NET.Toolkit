@page "/tools/crypto"

<h4>Crypto Toolkit</h4>
<p class="text-muted">Offline cryptographic utilities: K12 hash, verify signatures.</p>

<div class="row g-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">K12 Hash</div>
            <div class="card-body">
                <div class="mb-2">
                    <label class="form-label-sm">Input (hex)</label>
                    <textarea class="form-control form-control-sm mono" rows="2" @bind="_hashInput"></textarea>
                </div>
                <button class="btn btn-sm btn-primary" @onclick="ComputeHash">Hash</button>
                @if (_hashResult != null)
                {
                    <div class="mt-2">
                        <label class="form-label-sm">K12 (32 bytes)</label>
                        <input class="form-control form-control-sm mono" value="@_hashResult" readonly />
                    </div>
                }
                @if (_hashError != null)
                {
                    <div class="text-danger small mt-1">@_hashError</div>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Verify Signature</div>
            <div class="card-body">
                <div class="mb-2">
                    <label class="form-label-sm">Public Key (64 hex) or Identity (60 chars)</label>
                    <input class="form-control form-control-sm mono" @bind="_verifyPubKey" />
                </div>
                <div class="mb-2">
                    <label class="form-label-sm">Message (hex)</label>
                    <textarea class="form-control form-control-sm mono" rows="2" @bind="_verifyMessage"></textarea>
                </div>
                <div class="mb-2">
                    <label class="form-label-sm">Signature (128 hex)</label>
                    <textarea class="form-control form-control-sm mono" rows="2" @bind="_verifySignature"></textarea>
                </div>
                <button class="btn btn-sm btn-primary" @onclick="VerifySignature">Verify</button>
                @if (_verifyResult != null)
                {
                    <span class="ms-2 badge @(_verifyResult == true ? "bg-success" : "bg-danger")">
                        @(_verifyResult == true ? "Valid" : "Invalid")
                    </span>
                }
                @if (_verifyError != null)
                {
                    <div class="text-danger small mt-1">@_verifyError</div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private readonly Qubic.Crypto.QubicCrypt _crypt = new();

    // K12 Hash
    private string? _hashInput;
    private string? _hashResult;
    private string? _hashError;

    // Verify
    private string? _verifyPubKey;
    private string? _verifyMessage;
    private string? _verifySignature;
    private bool? _verifyResult;
    private string? _verifyError;

    private void ComputeHash()
    {
        _hashResult = null;
        _hashError = null;
        try
        {
            var input = string.IsNullOrWhiteSpace(_hashInput) ? [] : Convert.FromHexString(_hashInput.Trim());
            var hash = _crypt.KangarooTwelve(input, 32);
            _hashResult = Convert.ToHexString(hash).ToLowerInvariant();
        }
        catch (Exception ex) { _hashError = ex.Message; }
    }

    private void VerifySignature()
    {
        _verifyResult = null;
        _verifyError = null;
        try
        {
            if (string.IsNullOrWhiteSpace(_verifyPubKey))
            {
                _verifyError = "Public key or identity is required.";
                return;
            }
            if (string.IsNullOrWhiteSpace(_verifySignature))
            {
                _verifyError = "Signature is required.";
                return;
            }

            byte[] pubKey;
            var pkInput = _verifyPubKey.Trim();
            if (pkInput.Length == 60 && pkInput.All(c => c >= 'A' && c <= 'Z'))
                pubKey = Qubic.Core.Entities.QubicIdentity.FromIdentity(pkInput).PublicKey;
            else
                pubKey = Convert.FromHexString(pkInput);

            var message = string.IsNullOrWhiteSpace(_verifyMessage) ? [] : Convert.FromHexString(_verifyMessage.Trim());
            var signature = Convert.FromHexString(_verifySignature.Trim());

            _verifyResult = _crypt.Verify(pubKey, message, signature);
        }
        catch (Exception ex) { _verifyError = ex.Message; }
    }
}
